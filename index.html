<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dombik Blast">
    <meta name="theme-color" content="#4A76FD">
    <title>Dombik Blast - Pro Edition</title>
    <style>
        :root {
            --cell: 42px;
            --gap: 3px;
            --radius: 4px;
            --bg-game: #4A76FD;
            --bg-grid: #131E3D;
            --bg-cell: #1C2B54;
            --text-gold: #FFD700;
        }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            background: #4A76FD;
            color: #fff;
            font-family: 'Arial Rounded MT Bold', 'Helvetica', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes screenShake {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-5px, 5px) rotate(-1deg); }
            40% { transform: translate(5px, -5px) rotate(1deg); }
            60% { transform: translate(-5px, -5px) rotate(-1deg); }
            80% { transform: translate(5px, 5px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .shake-active { animation: screenShake 0.3s ease-in-out; }

        @keyframes fire {
            0% { text-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d, 0 -5px 15px #ff944d; box-shadow: 0 0 15px #ff4d4d; }
            50% { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff4d4d, 0 -10px 25px #ff944d; box-shadow: 0 0 25px #ff0000; }
            100% { text-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d, 0 -5px 15px #ff944d; box-shadow: 0 0 15px #ff4d4d; }
        }
        @keyframes voidAnim {
            0% { box-shadow: 0 0 15px #2D0054, inset 0 0 10px #000; border-color: #1a0033; filter: brightness(0.8); }
            50% { box-shadow: 0 0 35px #6A00B0, inset 0 0 20px #000; border-color: #4B0082; filter: brightness(1.2); }
            100% { box-shadow: 0 0 15px #2D0054, inset 0 0 10px #000; border-color: #1a0033; filter: brightness(0.8); }
        }
        @keyframes megaChadAnim {
            0%   { box-shadow: 0 0 20px #FFD700, inset 0 0 10px #b8860b; border-color: #FFD700; filter: brightness(1); }
            50%  { box-shadow: 0 0 45px #FFD700, inset 0 0 25px #FFD700; border-color: #fff176; filter: brightness(1.4); }
            100% { box-shadow: 0 0 20px #FFD700, inset 0 0 10px #b8860b; border-color: #FFD700; filter: brightness(1); }
        }
        @keyframes filAnim {
            0%   { box-shadow: 0 0 20px #00BCD4, inset 0 0 10px #006064; border-color: #00BCD4; filter: brightness(0.9); }
            50%  { box-shadow: 0 0 50px #00E5FF, inset 0 0 25px #00BCD4; border-color: #80DEEA; filter: brightness(1.3); }
            100% { box-shadow: 0 0 20px #00BCD4, inset 0 0 10px #006064; border-color: #00BCD4; filter: brightness(0.9); }
        }
        @keyframes poloAnim {
            0%   { box-shadow: 0 0 20px #FF6F00, inset 0 0 10px #E65100; border-color: #FF6F00; filter: hue-rotate(0deg) brightness(1); }
            50%  { box-shadow: 0 0 50px #FFAB40, inset 0 0 25px #FF6F00; border-color: #FFD180; filter: hue-rotate(15deg) brightness(1.4); }
            100% { box-shadow: 0 0 20px #FF6F00, inset 0 0 10px #E65100; border-color: #FF6F00; filter: hue-rotate(0deg) brightness(1); }
        }
        @keyframes engellAnim {
            0%   { box-shadow: 0 0 20px #F44336, inset 0 0 10px #B71C1C; border-color: #F44336; filter: brightness(1); }
            33%  { box-shadow: 0 0 40px #FF9800, inset 0 0 20px #E65100; border-color: #FF9800; filter: brightness(1.2); }
            66%  { box-shadow: 0 0 40px #4CAF50, inset 0 0 20px #1B5E20; border-color: #4CAF50; filter: brightness(1.2); }
            100% { box-shadow: 0 0 20px #F44336, inset 0 0 10px #B71C1C; border-color: #F44336; filter: brightness(1); }
        }
        @keyframes kozmikAnim {
            0%   { box-shadow: 0 0 25px #E040FB, inset 0 0 15px #4A148C; border-color: #E040FB; filter: hue-rotate(0deg) brightness(1); }
            25%  { box-shadow: 0 0 50px #40C4FF, inset 0 0 25px #01579B; border-color: #40C4FF; filter: hue-rotate(90deg) brightness(1.3); }
            50%  { box-shadow: 0 0 50px #69F0AE, inset 0 0 25px #1B5E20; border-color: #69F0AE; filter: hue-rotate(180deg) brightness(1.3); }
            75%  { box-shadow: 0 0 50px #FF6E40, inset 0 0 25px #BF360C; border-color: #FF6E40; filter: hue-rotate(270deg) brightness(1.3); }
            100% { box-shadow: 0 0 25px #E040FB, inset 0 0 15px #4A148C; border-color: #E040FB; filter: hue-rotate(360deg) brightness(1); }
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255,215,0,0.5); }
            50% { transform: scale(1.04); box-shadow: 0 0 50px rgba(255,215,0,0.8); }
        }

        .rank-eqo-fx     { animation: fire 1.5s infinite ease-in-out !important; border: 2px solid #ff4d4d !important; background: linear-gradient(45deg, #800000, #ff4d4d) !important; }
        .rank-sengolo-fx { animation: voidAnim 2s infinite ease-in-out !important; border: 3px solid #4B0082 !important; background: linear-gradient(45deg, #000, #1a0033, #000) !important; color: #fff !important; }
        .rank-megachad-fx { animation: megaChadAnim 1.8s infinite ease-in-out !important; border: 3px solid #FFD700 !important; background: linear-gradient(45deg, #3d2b00, #7a5500, #3d2b00) !important; color: #FFD700 !important; }
        .rank-fil-fx      { animation: filAnim 2s infinite ease-in-out !important; border: 3px solid #00BCD4 !important; background: linear-gradient(45deg, #001a1f, #003d47, #001a1f) !important; color: #80DEEA !important; }
        .rank-polo-fx     { animation: poloAnim 1.6s infinite ease-in-out !important; border: 3px solid #FF6F00 !important; background: linear-gradient(45deg, #2a1000, #6b2d00, #2a1000) !important; color: #FFAB40 !important; }
        .rank-engell-fx   { animation: engellAnim 2.5s infinite ease-in-out !important; border: 3px solid #F44336 !important; background: linear-gradient(45deg, #1a0000, #3a0a0a, #1a0000) !important; color: #fff !important; }
        .rank-kozmik-fx   { animation: kozmikAnim 3s infinite linear !important; border: 3px solid #E040FB !important; background: linear-gradient(45deg, #0a001a, #1a0033, #001a0a, #0a001a) !important; color: #fff !important; }

        @keyframes rankUpAnim {
            0% { transform: scale(0.3) rotate(-20deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .rank-up-overlay {
            position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            pointer-events: none; opacity: 0; transition: opacity 0.4s;
        }
        .rank-up-bg {
            position: absolute; inset: 0; opacity: 0.85;
        }
        .rank-up-card {
            position: relative; z-index: 1;
            padding: 28px 32px; border-radius: 28px; text-align: center;
            transform: scale(0.5); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 260px;
        }
        .rank-up-overlay.show { opacity: 1; }
        .rank-up-overlay.show .rank-up-card { transform: scale(1); }
        .rank-up-label { font-size: 13px; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; opacity: 0.8; margin-bottom: 6px; }
        .rank-up-name { font-size: 30px; font-weight: 900; margin: 8px 0; line-height: 1.1; }
        .rank-up-img { width: 100px; height: 100px; border-radius: 16px; object-fit: cover; margin: 12px auto; display: block; border: 3px solid rgba(255,255,255,0.4); }
        .rank-up-msg { font-size: 14px; font-weight: 700; opacity: 0.9; margin-top: 8px; }

        .confetti { position: absolute; width: 10px; height: 10px; z-index: 10000; pointer-events: none; }

        @keyframes dombikPop {
            0% { transform: translate(-50%, -20%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(0.8); opacity: 0; }
        }

        .dombik-text {
            position: absolute; top: 50%; left: 50%; font-weight: 900; z-index: 10000;
            pointer-events: none; white-space: nowrap; animation: dombikPop 1s ease-out forwards;
        }

        .super { color: var(--text-gold); font-size: 42px; text-shadow: 0 0 25px rgba(0,0,0,0.8), 0 4px 0 #b8860b; }
        .ultra { color: #fff; font-size: 48px; text-shadow: 0 0 35px #ff0000, 0 5px 0 #8b0000; letter-spacing: 1px; }

        .will-explode { filter: brightness(1.8) saturate(1.6); box-shadow: 0 0 20px rgba(255,255,255,0.9), 0 0 40px rgba(255,255,255,0.4) !important; z-index: 5; transform: scale(0.93); transition: all 0.1s !important; }
        .cell.game-over-gray { filter: grayscale(1) brightness(0.4) !important; transition: filter 2s ease, brightness 2s ease !important; }

        .game-wrapper {
            background: var(--bg-game); width: 100%; max-width: 400px;
            height: 100vh;
            height: 100dvh;
            min-height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }

        #header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px 5px 20px; box-sizing: border-box; }
        .high-score-box { display: flex; align-items: center; color: var(--text-gold); font-size: 24px; font-weight: bold; }
        .header-icons { display: flex; gap: 15px; align-items: center; }

        .rank-btn {
            background: rgba(0,0,0,0.4); padding: 6px 12px; border-radius: 14px; border: 2px solid var(--text-gold);
            color: white; cursor: pointer; display: flex; align-items: center; gap: 10px; min-width: 130px;
            transition: all 0.3s ease;
        }

        .rank-btn-icon { width: 40px; height: 40px; background: #131E3D; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .rank-btn-icon img { width: 100%; height: 100%; object-fit: cover; }
        .settings-icon { font-size: 32px; color: #fff; cursor: pointer; }

        #score { font-size: 65px; font-weight: 900; color: white; margin: 8px 0; letter-spacing: -2px; }

        #game-container { background: var(--bg-grid); padding: 8px; border-radius: 12px; border: 4px solid #1a2a5a; position: relative; }
        #grid { display: grid; grid-template-columns: repeat(8, var(--cell)); grid-template-rows: repeat(8, var(--cell)); gap: var(--gap); }
        .cell { width: var(--cell); height: var(--cell); background: var(--bg-cell); border-radius: var(--radius); transition: background 0.2s, filter 0.2s; position: relative; }
        .filled {
            border-radius: var(--radius);
            box-shadow:
                inset 0 5px 0 rgba(255,255,255,0.55),
                inset 0 -5px 0 rgba(0,0,0,0.45),
                inset 5px 0 0 rgba(255,255,255,0.20),
                inset -5px 0 0 rgba(0,0,0,0.30),
                0 2px 8px rgba(0,0,0,0.4);
        }

        #dock { margin-top: 16px; display: flex; gap: 15px; height: 120px; align-items: center; }
        .slot { width: 105px; height: 105px; display: flex; justify-content: center; align-items: center; }
        .piece { display: grid; gap: 2px; }
        .p-cell { width: 16px; height: 16px; border-radius: 4px; }
        .p-cell.filled {
            box-shadow:
                inset 0 3px 0 rgba(255,255,255,0.55),
                inset 0 -3px 0 rgba(0,0,0,0.40),
                inset 3px 0 0 rgba(255,255,255,0.20),
                inset -3px 0 0 rgba(0,0,0,0.25),
                0 2px 5px rgba(0,0,0,0.35);
        }

        .dragging { position: fixed !important; z-index: 1000; pointer-events: none; transition: none !important; will-change: left, top; }
        .preview { opacity: 0.35 !important; }

        .overlay { position: fixed; inset: 0; background: rgba(19, 30, 61, 0.95); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
        .modal-card { background: #243b7a; padding: 25px; border-radius: 30px; text-align: center; border: 5px solid #4A76FD; width: 85%; max-width: 340px; max-height: 80vh; overflow-y: auto; }

        .rank-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); margin: 6px 0; padding: 10px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .rank-item.active { border-color: var(--text-gold); background: rgba(255,215,0,0.12); box-shadow: 0 0 16px rgba(255,215,0,0.15); }
        .rank-icon-placeholder { width: 44px; height: 44px; background: #131E3D; border-radius: 10px; margin-right: 10px; overflow: hidden; flex-shrink:0; }
        .rank-icon-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .rank-info { flex: 1; min-width: 0; }
        .rank-name { display: block; font-weight: 900; font-size: 13px; letter-spacing: 0.5px; }
        .rank-score { display: block; font-size: 10px; color: rgba(255,255,255,0.4); margin: 2px 0 5px; }
        .rank-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .rank-bar-fill { height: 100%; border-radius: 4px; width: 100%; }
        .rank-crown { font-size: 18px; margin-left: 8px; flex-shrink: 0; }

        .btn { width: 100%; padding: 16px 0; font-size: 20px; font-weight: bold; border-radius: 15px; border: none; background: linear-gradient(to bottom, #FFD700, #DAA520); color: #131E3D; margin: 10px 0; cursor: pointer; box-shadow: 0 6px 0 #9e7b00; text-transform: uppercase; transition: transform 0.08s, box-shadow 0.08s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #9e7b00; }

        /* Ayarlar men√ºs√º */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 4px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .setting-label { display: flex; align-items: center; gap: 10px; color: white; font-size: 16px; font-weight: bold; }
        .setting-icon { font-size: 20px; }
        .toggle-switch { position: relative; width: 52px; height: 28px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; inset: 0; background: rgba(255,255,255,0.2); border-radius: 28px; cursor: pointer; transition: background 0.3s; }
        .toggle-slider:before { content: ''; position: absolute; width: 22px; height: 22px; left: 3px; top: 3px; background: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .toggle-switch input:checked + .toggle-slider { background: #00E676; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .btn-menu-primary { width: 80px; height: 80px; padding: 0; font-size: 36px; font-weight: bold; border-radius: 8px; border: none; background: linear-gradient(160deg, #00E676, #00C853); color: #fff; cursor: pointer; box-shadow: 0 6px 0 #007B33, 0 0 30px rgba(0,230,118,0.4); display: flex; align-items: center; justify-content: center; margin: 0 auto; text-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.08s, box-shadow 0.08s; }
        .btn-menu-primary:active { transform: translateY(5px) scale(0.95); box-shadow: 0 1px 0 #007B33, 0 0 10px rgba(0,230,118,0.2); }
        .btn-menu-secondary { width: 100%; padding: 12px; font-size: 15px; font-weight: bold; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; margin: 10px 0 0; cursor: pointer; text-align: center; letter-spacing: 0.5px; transition: transform 0.08s, background 0.08s; }
        .btn-menu-secondary:active { transform: scale(0.97); background: rgba(255,255,255,0.18); }

        /* Ana men√º */
        .main-menu-card {
            position: relative; overflow-y: auto; overflow-x: hidden;
            background: linear-gradient(160deg, #0f1b4d 0%, #1a2f7a 40%, #0d1a45 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 28px; padding: 28px 22px 24px;
            width: 88%; max-width: 340px; max-height: 88vh;
            box-shadow: 0 0 60px rgba(74,118,253,0.4), 0 0 0 1px rgba(255,255,255,0.05);
        }
        .menu-bg-dots {
            position: absolute; inset: 0; border-radius: 28px; overflow: hidden; pointer-events: none;
            background-image: radial-gradient(rgba(255,255,255,0.06) 1px, transparent 1px);
            background-size: 22px 22px;
        }
        .menu-logo-wrap { text-align: center; margin-bottom: 22px; position: relative; }
        .menu-logo { width: 130px; filter: drop-shadow(0 6px 20px rgba(74,118,253,0.6)); animation: logoFloat 3s ease-in-out infinite; }
        @keyframes logoFloat {
            0%,100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        .menu-subtitle { font-size: 11px; letter-spacing: 4px; color: rgba(255,255,255,0.35); margin-top: 6px; text-transform: uppercase; }

        /* Bilmen gerekenler */
        .info-section { margin-top: 18px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 16px; }
        .info-title { font-size: 12px; font-weight: 900; letter-spacing: 2px; color: #FFD700; margin-bottom: 12px; text-align: center; }
        .info-list { display: flex; flex-direction: column; gap: 10px; }
        .info-item { display: flex; align-items: flex-start; gap: 10px; background: rgba(255,255,255,0.04); border-radius: 12px; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.06); }
        .info-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
        .info-item span:last-child { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        .info-item b { color: #FFD700; }
        .btn-setting { width: 100%; padding: 12px; font-size: 15px; font-weight: bold; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; margin: 5px 0; cursor: pointer; text-align: left; letter-spacing: 0.5px; transition: transform 0.08s, background 0.08s; }
        .btn-setting:active { transform: scale(0.97); background: rgba(255,255,255,0.2); }
        .btn-setting-close { width: 100%; padding: 12px; font-size: 15px; font-weight: bold; border-radius: 12px; border: none; background: rgba(255,77,77,0.25); color: #ff8080; margin: 5px 0; cursor: pointer; text-align: left; letter-spacing: 0.5px; transition: transform 0.08s, background 0.08s; }
        .btn-setting-close:active { transform: scale(0.97); background: rgba(255,77,77,0.4); }
        .hidden { display: none !important; }

        .particle { position: absolute; pointer-events: none; z-index: 2000; border-radius: 2px; }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(20,20,40,0.95); color: #fff; padding: 12px 24px; border-radius: 20px; font-size: 15px; font-weight: bold; z-index: 99999; border: 2px solid #ff4d4d; display: none; text-align: center; white-space: nowrap; }

        #revive-section { margin: 10px 0; }
        #countdown-ring { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        #countdown-ring svg { transform: rotate(-90deg); }
        #countdown-ring circle.bg { fill: none; stroke: rgba(255,255,255,0.15); stroke-width: 6; }
        #countdown-ring circle.progress { fill: none; stroke: #FFD700; stroke-width: 6; stroke-linecap: round; stroke-dasharray: 220; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.3s; }
        #countdown-num { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #FFD700; }
        .btn-revive { width: 100%; padding: 16px 0; font-size: 18px; font-weight: bold; border-radius: 15px; border: none; background: linear-gradient(to bottom, #00E676, #00C853); color: #fff; margin: 6px 0; cursor: pointer; box-shadow: 0 6px 0 #007B33; text-transform: uppercase; transition: transform 0.08s, box-shadow 0.08s; }
        .btn-revive:active { transform: translateY(4px); box-shadow: 0 2px 0 #007B33; }

        .c-1  { background: linear-gradient(145deg, #FF6B35, #C1360A); }
        .c-2  { background: linear-gradient(145deg, #4CAF50, #1B5E20); }
        .c-3  { background: linear-gradient(145deg, #E040FB, #6A00C8); }
        .c-4  { background: linear-gradient(145deg, #FFEB3B, #F57F17); }
        .c-5  { background: linear-gradient(145deg, #42A5F5, #0D47A1); }
        .c-6  { background: linear-gradient(145deg, #26C6DA, #00600F); }
        .c-7  { background: linear-gradient(145deg, #EF5350, #7F0000); }
        .c-8  { background: linear-gradient(145deg, #EC407A, #880E4F); }
        .c-9  { background: linear-gradient(145deg, #5C6BC0, #1A237E); }
        .c-10 { background: linear-gradient(145deg, #00E676, #00600F); }
        .c-11 { background: linear-gradient(145deg, #FFA726, #BF360C); }
        .c-12 { background: linear-gradient(145deg, #7C4DFF, #311B92); }
        .c-13 { background: linear-gradient(145deg, #FF7043, #BF360C); }
        .c-14 { background: linear-gradient(145deg, #66BB6A, #1B5E20); }
        .c-15 { background: linear-gradient(145deg, #29B6F6, #01579B); }
        .c-16 { background: linear-gradient(145deg, #CE93D8, #4A148C); }
        .c-17 { background: linear-gradient(145deg, #F06292, #880E4F); }
        .c-18 { background: linear-gradient(145deg, #FFD740, #E65100); }
    </style>
</head>
<body>

<audio id="place-sound" src="koy.mp3" preload="auto"></audio>
<audio id="blast-sound" src="patla.mp3" preload="auto"></audio>
<audio id="bg-music" src="50.mp3" loop preload="auto"></audio>

<div id="rank-up-popup" class="rank-up-overlay">
    <div class="rank-up-bg" id="pop-bg"></div>
    <div class="rank-up-card" id="pop-card">
        <div class="rank-up-label" id="pop-label">R√úTBE ATLADIN!</div>
        <div class="rank-up-name" id="pop-rank-name">≈ûENGOLO</div>
        <img class="rank-up-img" id="pop-rank-img" src="">
        <div class="rank-up-msg" id="pop-msg">SEN Bƒ∞R EFSANESƒ∞N!</div>
    </div>
</div>

<div class="game-wrapper" id="main-wrapper">
    <div id="main-menu" class="overlay">
        <div class="main-menu-card">
            <!-- Animasyonlu arka plan partik√ºlleri -->
            <div class="menu-bg-dots"></div>

            <!-- Logo + ba≈ülƒ±k -->
            <div class="menu-logo-wrap">
                <img src="logo.png" alt="Logo" class="menu-logo">
                <div class="menu-subtitle">BLOCK PUZZLE</div>
            </div>

            <!-- Oyuna ba≈üla butonu -->
            <button class="btn-menu-primary" onclick="startGame()">‚ñ∂</button>

            <!-- Ayarlar -->
            <button class="btn-menu-secondary" onclick="showSettings()">‚öôÔ∏è &nbsp;Ayarlar</button>

            <!-- Bilmen gerekenler -->
            <div class="info-section">
                <div class="info-title">üìñ Bƒ∞LMEN GEREKENLER</div>
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-icon">üìà</span>
                        <span>Her yeni r√ºtbede bloklar b√ºy√ºr, tahta daha hƒ±zlƒ± dolar ‚Äî zorluk artar!</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üî•</span>
                        <span>Ard arda sƒ±ra kƒ±r: <b>DOMBƒ∞K 2x, 3x...</b> Seri puanƒ± katlar!</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">‚ö°</span>
                        <span>Aynƒ± anda 2 sƒ±ra = <b>S√úPER DOMBƒ∞K x3</b>, 3+ sƒ±ra = <b>ULTRA DOMBƒ∞K x5</b></span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üì∫</span>
                        <span>Her oyunda <b>3 canlanma hakkƒ±n</b> var. ƒ∞nternet olmadan reklam izleyemezsin.</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üëë</span>
                        <span>En y√ºksek rekorunu kƒ±r, <b>KOZMƒ∞K UƒûUR B√ñCEƒûƒ∞</b>'ne ula≈ü!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-menu" class="overlay hidden">
        <div class="modal-card" style="padding:20px;">
            <h2 style="color:white; margin:0 0 20px 0; font-size:20px; letter-spacing:1px;">‚öôÔ∏è AYARLAR</h2>

            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-icon">üîä</span>
                    <span>Ses Efektleri</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="vib-toggle-btn" onchange="toggleVibration()" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-icon">üì≥</span>
                    <span>Titre≈üim</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="haptic-toggle-btn" onchange="toggleHaptic()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-icon">üéµ</span>
                    <span>M√ºzik</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="music-toggle-btn" onchange="toggleMusic()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div style="height:1px; background:rgba(255,255,255,0.1); margin:16px 0;"></div>

            <button class="btn-setting" onclick="resetGame()">üîÑ Ba≈ütan Ba≈üla</button>
            <button class="btn-setting" onclick="backToMenu()">üè† Ana Men√º</button>
            <button class="btn-setting-close" onclick="hideSettings()">‚úï Kapat</button>
        </div>
    </div>

    <div id="rank-panel" class="overlay hidden">
        <div class="modal-card" style="padding:20px;">
            <div style="text-align:center; margin-bottom:16px;">
                <div style="font-size:26px; font-weight:900; color:var(--text-gold); letter-spacing:1px;">üèÜ R√úTBELER</div>
                <div style="font-size:12px; color:rgba(255,255,255,0.4); margin-top:4px;">Ne kadar y√ºksek √ßƒ±kabilirsin?</div>
            </div>
            <div id="rank-list">
                <div class="rank-item" id="rank-100000">
                    <div class="rank-icon-placeholder"><img src="kozmik.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#E040FB;">KOZMƒ∞K UƒûUR B√ñCEƒûƒ∞</span>
                        <span class="rank-score">100.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-100000" class="rank-bar-fill" style="background:linear-gradient(90deg,#E040FB,#40C4FF,#69F0AE);"></div></div>
                    </div>
                    <div class="rank-crown">üêû</div>
                </div>
                <div class="rank-item" id="rank-70000">
                    <div class="rank-icon-placeholder"><img src="engelli.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#FF5252;">ENGELLƒ∞ HUNTER 55</span>
                        <span class="rank-score">70.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-70000" class="rank-bar-fill" style="background:linear-gradient(90deg,#F44336,#FF9800,#4CAF50);"></div></div>
                    </div>
                    <div class="rank-crown">üéØ</div>
                </div>
                <div class="rank-item" id="rank-50000">
                    <div class="rank-icon-placeholder"><img src="nemo.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#FFAB40;">KAYIP BALIK MEMO</span>
                        <span class="rank-score">50.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-50000" class="rank-bar-fill" style="background:linear-gradient(90deg,#FF6F00,#FFAB40);"></div></div>
                    </div>
                    <div class="rank-crown">üêü</div>
                </div>
                <div class="rank-item" id="rank-35000">
                    <div class="rank-icon-placeholder"><img src="filrank.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#80DEEA;">Fƒ∞L</span>
                        <span class="rank-score">35.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-35000" class="rank-bar-fill" style="background:linear-gradient(90deg,#00BCD4,#80DEEA);"></div></div>
                    </div>
                    <div class="rank-crown">üêò</div>
                </div>
                <div class="rank-item" id="rank-25000">
                    <div class="rank-icon-placeholder"><img src="goldrank.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#FFD700;">MEGA CHAD</span>
                        <span class="rank-score">25.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-25000" class="rank-bar-fill" style="background:linear-gradient(90deg,#FFD700,#fff176);"></div></div>
                    </div>
                    <div class="rank-crown">üí™</div>
                </div>
                <div class="rank-item" id="rank-20000">
                    <div class="rank-icon-placeholder"><img src="sengolo.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#A855F7;">≈ûENGOLO</span>
                        <span class="rank-score">20.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-20000" class="rank-bar-fill" style="background:linear-gradient(90deg,#A855F7,#7C3AED);"></div></div>
                    </div>
                    <div class="rank-crown">üëë</div>
                </div>
                <div class="rank-item" id="rank-12000">
                    <div class="rank-icon-placeholder"><img src="eko.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#ff4d4d;">!EKO!</span>
                        <span class="rank-score">12.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-12000" class="rank-bar-fill" style="background:linear-gradient(90deg,#ff4d4d,#b91c1c);"></div></div>
                    </div>
                    <div class="rank-crown">üî•</div>
                </div>
                <div class="rank-item" id="rank-8000">
                    <div class="rank-icon-placeholder"><img src="ibo.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#60a5fa;">ƒ∞BO!!</span>
                        <span class="rank-score">8.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-8000" class="rank-bar-fill" style="background:linear-gradient(90deg,#3b82f6,#1d4ed8);"></div></div>
                    </div>
                    <div class="rank-crown">‚ö°</div>
                </div>
                <div class="rank-item" id="rank-5000">
                    <div class="rank-icon-placeholder"><img src="sekko.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#34d399;">Rƒ∞DER 125</span>
                        <span class="rank-score">5.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-5000" class="rank-bar-fill" style="background:linear-gradient(90deg,#10b981,#065f46);"></div></div>
                    </div>
                    <div class="rank-crown">üèçÔ∏è</div>
                </div>
                <div class="rank-item" id="rank-3000">
                    <div class="rank-icon-placeholder"><img src="feribot.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#fbbf24;">FERƒ∞-BOT</span>
                        <span class="rank-score">3.000+ Puan</span>
                        <div class="rank-bar"><div id="bar-3000" class="rank-bar-fill" style="background:linear-gradient(90deg,#f59e0b,#b45309);"></div></div>
                    </div>
                    <div class="rank-crown">‚õ¥Ô∏è</div>
                </div>
                <div class="rank-item" id="rank-1500">
                    <div class="rank-icon-placeholder"><img src="TVS.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#f472b6;">SEDO TVS</span>
                        <span class="rank-score">1.500+ Puan</span>
                        <div class="rank-bar"><div id="bar-1500" class="rank-bar-fill" style="background:linear-gradient(90deg,#ec4899,#9d174d);"></div></div>
                    </div>
                    <div class="rank-crown">üõµ</div>
                </div>
                <div class="rank-item" id="rank-500">
                    <div class="rank-icon-placeholder"><img src="vakko.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:#a3e635;">VAKKO</span>
                        <span class="rank-score">500+ Puan</span>
                        <div class="rank-bar"><div id="bar-500" class="rank-bar-fill" style="background:linear-gradient(90deg,#84cc16,#3f6212);"></div></div>
                    </div>
                    <div class="rank-crown">üåø</div>
                </div>
                <div class="rank-item" id="rank-0">
                    <div class="rank-icon-placeholder"><img src="d√ºr√ºmb√ºs_memo.png"></div>
                    <div class="rank-info">
                        <span class="rank-name" style="color:rgba(255,255,255,0.6);">D√ºr√ºmb√ºs Memo</span>
                        <span class="rank-score">Ba≈ülangƒ±√ß</span>
                        <div class="rank-bar"><div id="bar-0" class="rank-bar-fill" style="background:rgba(255,255,255,0.3);"></div></div>
                    </div>
                    <div class="rank-crown">üå±</div>
                </div>
            </div>
            <button class="btn-setting-close" style="margin-top:12px;" onclick="hideRankPanel()">‚úï Kapat</button>
        </div>
    </div>

    <div id="toast"></div>
    <div id="game-over" class="overlay hidden" style="background:rgba(5,0,20,0.92); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);">
        <div style="
            position:relative; width:88%; max-width:340px;
            background: linear-gradient(160deg, #0f0020 0%, #1a0035 50%, #0a0018 100%);
            border-radius: 32px;
            border: 2px solid rgba(255,77,77,0.5);
            box-shadow: 0 0 60px rgba(255,50,50,0.25), 0 0 120px rgba(180,0,255,0.15), inset 0 1px 0 rgba(255,255,255,0.08);
            padding: 28px 24px 24px;
            text-align: center;
            overflow: hidden;
        ">
            <!-- Arka plan ƒ±zgara deseni -->
            <div style="position:absolute;inset:0;border-radius:32px;background-image:radial-gradient(rgba(255,77,77,0.07) 1px, transparent 1px);background-size:18px 18px;pointer-events:none;"></div>

            <!-- √úst dekor √ßizgisi -->
            <div style="position:absolute;top:0;left:10%;right:10%;height:2px;background:linear-gradient(90deg,transparent,#ff4d4d,#e040fb,transparent);border-radius:2px;"></div>

            <!-- YENƒ∞ REKOR banner -->
            <div id="new-record-alert" class="hidden" style="
                position:relative; margin: 0 0 16px;
                background: linear-gradient(135deg, #b8860b, #FFD700, #b8860b);
                border-radius: 16px; padding: 10px 16px;
                font-size: 15px; font-weight: 900; color: #000;
                letter-spacing: 2px; box-shadow: 0 0 30px rgba(255,215,0,0.5);
                animation: recordPulse 1s ease-in-out infinite;
            ">üëë YENƒ∞ REKOR! üëë</div>

            <!-- OYUN Bƒ∞TTƒ∞ ba≈ülƒ±ƒüƒ± -->
            <div style="position:relative; margin-bottom: 4px;">
                <div style="font-size:11px; font-weight:900; letter-spacing:5px; color:rgba(255,100,100,0.7); margin-bottom:6px;">‚óè OYUN Bƒ∞TTƒ∞ ‚óè</div>
                <div style="font-size:42px; font-weight:900; color:#ff4d4d; letter-spacing:2px; text-shadow:0 0 30px rgba(255,77,77,0.8), 0 0 60px rgba(255,77,77,0.3); line-height:1;">üíÄ GAME<br>OVER</div>
            </div>

            <!-- Skor kutusu -->
            <div style="
                position:relative; margin: 18px 0 16px;
                background: rgba(255,255,255,0.04);
                border: 1px solid rgba(255,215,0,0.2);
                border-radius: 20px; padding: 14px 20px;
            ">
                <div style="font-size:10px; font-weight:900; letter-spacing:4px; color:rgba(255,215,0,0.6); margin-bottom:6px;">SKORUN</div>
                <div id="final-score" style="font-size:62px; font-weight:900; color:#FFD700; line-height:1; text-shadow:0 0 20px rgba(255,215,0,0.6);">0</div>
            </div>

            <!-- Canlanma b√∂l√ºm√º -->
            <div id="revive-section" style="margin-bottom:14px;">
                <div id="revive-lives" style="color:rgba(255,255,255,0.5); font-size:12px; margin-bottom:10px; letter-spacing:1px;"></div>
                <div id="countdown-ring" style="position:relative; width:70px; height:70px; margin:0 auto 10px;">
                    <svg width="70" height="70" viewBox="0 0 80 80" style="transform:rotate(-90deg)">
                        <circle class="bg" cx="40" cy="40" r="35"/>
                        <circle class="progress" id="countdown-circle" cx="40" cy="40" r="35"/>
                    </svg>
                    <div id="countdown-num" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:#FFD700;">10</div>
                </div>
                <button class="btn-revive" id="btn-revive" onclick="reviveGame()" style="
                    background: linear-gradient(135deg, #00C853, #00E676);
                    border-radius: 16px; font-size:15px; letter-spacing:1px;
                    box-shadow: 0 6px 0 #007B33, 0 0 30px rgba(0,230,118,0.3);
                ">üì∫ Vƒ∞DEO ƒ∞ZLE VE CANLAN</button>
            </div>

            <!-- Alt butonlar -->
            <button onclick="resetGame()" style="
                width:100%; padding:15px 0; margin:6px 0;
                background: linear-gradient(135deg, #ff4d4d, #c0392b);
                border:none; border-radius:16px; color:#fff;
                font-size:17px; font-weight:900; letter-spacing:1px; cursor:pointer;
                box-shadow: 0 6px 0 #7f0000, 0 0 25px rgba(255,77,77,0.3);
                transition: transform 0.08s, box-shadow 0.08s;
                font-family: inherit;
            " onmousedown="this.style.transform='translateY(4px)';this.style.boxShadow='0 2px 0 #7f0000'" onmouseup="this.style.transform='';this.style.boxShadow='0 6px 0 #7f0000, 0 0 25px rgba(255,77,77,0.3)'">üîÑ TEKRAR DENE</button>

            <button onclick="backToMenu()" style="
                width:100%; padding:13px 0; margin:4px 0 0;
                background: rgba(255,255,255,0.08);
                border: 1px solid rgba(255,255,255,0.15);
                border-radius:16px; color:rgba(255,255,255,0.8);
                font-size:15px; font-weight:700; cursor:pointer;
                transition: background 0.2s;
                font-family: inherit;
            " onmousedown="this.style.background='rgba(255,255,255,0.15)'" onmouseup="this.style.background='rgba(255,255,255,0.08)'">üè† ANA MEN√ú</button>

            <!-- Alt dekor √ßizgisi -->
            <div style="position:absolute;bottom:0;left:10%;right:10%;height:2px;background:linear-gradient(90deg,transparent,#e040fb,#ff4d4d,transparent);border-radius:2px;"></div>
        </div>
    </div>

    <!-- Video Overlay -->
    <div id="video-overlay" style="display:none; position:fixed; inset:0; background:#000; z-index:99999; flex-direction:column; justify-content:center; align-items:center;">
        <div style="position:relative; width:100%; max-width:400px; height:100%;">
            <!-- √úst bar -->
            <div style="position:absolute; top:0; left:0; right:0; z-index:2; display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);">
                <div style="color:#FFD700; font-size:13px; font-weight:900; letter-spacing:1px;">üì∫ REKLAM</div>
                <div id="ad-timer" style="background:rgba(0,0,0,0.6); color:#fff; font-size:13px; font-weight:bold; padding:5px 12px; border-radius:20px; border:1px solid rgba(255,255,255,0.2);">‚è≥ <span id="ad-seconds">15</span>s</div>
            </div>
            <!-- Video -->
            <video id="ad-video" style="width:100%; height:100%; object-fit:cover; display:block;" playsinline webkit-playsinline muted></video>
            <!-- Alt bar -->
            <div style="position:absolute; bottom:0; left:0; right:0; z-index:2; padding:16px 14px; background:linear-gradient(to top, rgba(0,0,0,0.85), transparent);">
                <div style="color:rgba(255,255,255,0.5); font-size:11px; margin-bottom:8px; letter-spacing:1px;">Canlanmak i√ßin reklamƒ± izle</div>
                <button id="ad-skip-btn" onclick="skipVideoNow()" style="
                    display:none; width:100%; padding:13px; border:none; border-radius:14px;
                    background:linear-gradient(135deg,#00C853,#00E676); color:#fff;
                    font-size:16px; font-weight:900; cursor:pointer; font-family:inherit;
                    box-shadow: 0 4px 0 #007B33;
                ">‚úÖ CANLAN!</button>
                <div id="ad-skip-info" style="color:rgba(255,255,255,0.4); font-size:12px; text-align:center;">Reklam bittikten sonra canlanabilirsin</div>
            </div>
        </div>
    </div>

    <div id="header">
        <div class="high-score-box">üëë <span id="best">0</span></div>
        <div class="header-icons">
            <div class="rank-btn" id="header-rank-btn" onclick="showRankPanel()">
                <div class="rank-btn-icon"><img src="d√ºr√ºmb√ºs_memo.png" id="current-rank-img"></div>
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <span style="font-size:8px; color:var(--text-gold);">R√úTBE</span>
                    <span id="current-rank-name" style="font-size:11px; font-weight:bold; white-space:nowrap;">D√ºr√ºmb√ºs Memo</span>
                </div>
            </div>
            <div class="settings-icon" onclick="showSettings()">‚öôÔ∏è</div>
        </div>
    </div>

    <h1 id="score">0</h1>
    <div id="game-container"><div id="grid"></div></div>
    <div id="dock"></div>
</div>

<script>
    const gridEl = document.getElementById('grid');
    const dockEl = document.getElementById('dock');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const mainWrapper = document.getElementById('main-wrapper');
    const currentRankName = document.getElementById('current-rank-name');
    const currentRankImg = document.getElementById('current-rank-img');
    const headerRankBtn = document.getElementById('header-rank-btn');
    const gameOverEl = document.getElementById('game-over');
    const finalScoreEl = document.getElementById('final-score');
    const bgMusic = document.getElementById('bg-music');
    const placeSound = document.getElementById('place-sound');
    const blastSound = document.getElementById('blast-sound');
    const newRecordAlert = document.getElementById('new-record-alert');

    let score = 0;
    let board = Array(8).fill().map(() => Array(8).fill(null));
    let activeDrag = null;
    let comboStreak = 0; // ard arda sƒ±ra kƒ±rma sayacƒ±
    let isGameActive = false;
    let isVibrationEnabled = localStorage.getItem('vibrationEnabled') !== 'false';
    let isHapticEnabled = localStorage.getItem('hapticEnabled') !== 'false';
    let isMusicEnabled = localStorage.getItem('musicEnabled') === 'true';
    let sessionHighScoreReached = false;
    let currentRankThreshold = 0;

    const RANK_LEVELS = [
        {limit: 100000, name: "KOZMƒ∞K UƒûUR B√ñCEƒûƒ∞", img: "kozmik.png",   id: "rank-100000", fx: "rank-kozmik-fx"},
        {limit: 70000,  name: "ENGELLƒ∞ HUNTER 55",  img: "engelli.png",  id: "rank-70000",  fx: "rank-engell-fx"},
        {limit: 50000,  name: "KAYIP BALIK MEMO",    img: "memo.png",     id: "rank-50000",  fx: "rank-polo-fx"},
        {limit: 35000,  name: "Fƒ∞L",                 img: "fil.png",      id: "rank-35000",  fx: "rank-fil-fx"},
        {limit: 25000,  name: "MEGA CHAD",           img: "megachad.png", id: "rank-25000",  fx: "rank-megachad-fx"},
        {limit: 20000,  name: "≈ûENGOLO",             img: "sengolo.png",  id: "rank-20000",  fx: "rank-sengolo-fx"},
        {limit: 12000,  name: "EQO",                 img: "eko.png",      id: "rank-12000",  fx: "rank-eqo-fx"},
        {limit: 8000,   name: "ƒ∞BO!!",               img: "ibo.png",      id: "rank-8000",   fx: ""},
        {limit: 5000,   name: "Rƒ∞DER 125",           img: "sekko.png",    id: "rank-5000",   fx: ""},
        {limit: 3000,   name: "FERƒ∞-BOT",            img: "feribot.png",  id: "rank-3000",   fx: ""},
        {limit: 1500,   name: "SEDO TVS",            img: "TVS.png",      id: "rank-1500",   fx: ""},
        {limit: 500,    name: "VAKKO",               img: "vakko.png",    id: "rank-500",    fx: ""},
        {limit: 0,      name: "D√ºr√ºmb√ºs Memo",       img: "d√ºr√ºmb√ºs_memo.png", id: "rank-0", fx: ""}
    ];

    // ===================== BLOKLAR =====================
    // ‚îÄ‚îÄ Block Blast standart bloklarƒ± + t√ºm benzersiz rotasyonlar ‚îÄ‚îÄ
    const SHAPES_SMALL = [
        // 1 h√ºcre
        {s:[[1]], c:'c-1', n:'dot'},
        // 2 h√ºcre ‚Äî domino
        {s:[[1,1]], c:'c-2', n:'dom_0'},
        {s:[[1],[1]], c:'c-3', n:'dom_90'},
        // 3 h√ºcre ‚Äî d√ºz
        {s:[[1,1,1]], c:'c-4', n:'tri_0'},
        {s:[[1],[1],[1]], c:'c-5', n:'tri_90'},
        // 3 h√ºcre ‚Äî k√∂≈üe (L/J mini) ‚Äî 4 rotasyon
        {s:[[1,0],[1,1]], c:'c-6', n:'corner_0'},
        {s:[[1,1],[1,0]], c:'c-7', n:'corner_90'},
        {s:[[1,1],[0,1]], c:'c-8', n:'corner_180'},
        {s:[[0,1],[1,1]], c:'c-9', n:'corner_270'},
        // 4 h√ºcre ‚Äî 2√ó2 kare
        {s:[[1,1],[1,1]], c:'c-10', n:'sq2'},
        // 4 h√ºcre ‚Äî d√ºz
        {s:[[1,1,1,1]], c:'c-11', n:'quad_0'},
        {s:[[1],[1],[1],[1]], c:'c-12', n:'quad_90'},
        // 4 h√ºcre ‚Äî L k√º√ß√ºk ‚Äî 4 rotasyon
        {s:[[1,0],[1,0],[1,1]], c:'c-1', n:'L_s_0'},
        {s:[[1,1,1],[1,0,0]], c:'c-2', n:'L_s_90'},
        {s:[[1,1],[0,1],[0,1]], c:'c-3', n:'L_s_180'},
        {s:[[0,0,1],[1,1,1]], c:'c-4', n:'L_s_270'},
        // 4 h√ºcre ‚Äî J k√º√ß√ºk ‚Äî 4 rotasyon
        {s:[[0,1],[0,1],[1,1]], c:'c-5', n:'J_s_0'},
        {s:[[1,0,0],[1,1,1]], c:'c-6', n:'J_s_90'},
        {s:[[1,1],[1,0],[1,0]], c:'c-7', n:'J_s_180'},
        {s:[[1,1,1],[0,0,1]], c:'c-8', n:'J_s_270'},
        // 4 h√ºcre ‚Äî T ‚Äî 4 rotasyon
        {s:[[1,1,1],[0,1,0]], c:'c-9', n:'T_0'},
        {s:[[0,1],[1,1],[0,1]], c:'c-10', n:'T_90'},
        {s:[[0,1,0],[1,1,1]], c:'c-11', n:'T_180'},
        {s:[[1,0],[1,1],[1,0]], c:'c-12', n:'T_270'},
        // 4 h√ºcre ‚Äî S ‚Äî 2 rotasyon
        {s:[[0,1,1],[1,1,0]], c:'c-1', n:'S_0'},
        {s:[[1,0],[1,1],[0,1]], c:'c-2', n:'S_90'},
        // 4 h√ºcre ‚Äî Z ‚Äî 2 rotasyon
        {s:[[1,1,0],[0,1,1]], c:'c-3', n:'Z_0'},
        {s:[[0,1],[1,1],[1,0]], c:'c-4', n:'Z_90'},
    ];

    const SHAPES_NORMAL = [
        // 6 h√ºcre ‚Äî 3√ó2 ve 2√ó3 dikd√∂rtgen
        {s:[[1,1,1],[1,1,1]], c:'c-6', n:'rect_3x2'},
        {s:[[1,1],[1,1],[1,1]], c:'c-11', n:'rect_2x3'},
        // 9 h√ºcre ‚Äî 3√ó3 kare
        {s:[[1,1,1],[1,1,1],[1,1,1]], c:'c-3', n:'sq3'},
        // 5 h√ºcre ‚Äî b√ºy√ºk k√∂≈üe 3√ó3 L ‚Äî 4 rotasyon
        {s:[[1,0,0],[1,0,0],[1,1,1]], c:'c-2', n:'corner_b_0'},
        {s:[[1,1,1],[1,0,0],[1,0,0]], c:'c-4', n:'corner_b_90'},
        {s:[[1,1,1],[0,0,1],[0,0,1]], c:'c-5', n:'corner_b_180'},
        {s:[[0,0,1],[0,0,1],[1,1,1]], c:'c-12', n:'corner_b_270'},
    ];

    function getSavedBest() { return parseInt(localStorage.getItem('blockPuzzleHighScore')) || 0; }
    let best = getSavedBest();
    bestEl.innerText = best;

    // ‚îÄ‚îÄ iOS Ses Unlock Sistemi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let audioUnlocked = false;
    function unlockAudio() {
        if (audioUnlocked) return;
        audioUnlocked = true;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const buf = ctx.createBuffer(1, 1, 22050);
            const src = ctx.createBufferSource();
            src.buffer = buf;
            src.connect(ctx.destination);
            src.start(0);
            ctx.resume().catch(() => {});
        } catch(e) {}
        [bgMusic, placeSound, blastSound].forEach(a => {
            if (!a) return;
            const p = a.play();
            if (p) p.then(() => {
                a.pause();
                try { a.currentTime = 0; } catch(e) {}
            }).catch(() => {});
        });
    }
    document.addEventListener('touchstart', unlockAudio, { once: true, passive: true });
    document.addEventListener('pointerdown', unlockAudio, { once: true, passive: true });
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function showRankPanel() {
        const bestScore = Math.max(score, best);
        // Rank sƒ±ralarƒ± (b√ºy√ºkten k√º√ß√ºƒüe) ve bir √ºst√ºndeki limit
        const levels = [100000, 70000, 50000, 35000, 25000, 20000, 12000, 8000, 5000, 3000, 1500, 500, 0];
        levels.forEach((limit, i) => {
            const bar = document.getElementById('bar-' + limit);
            if(!bar) return;
            const prevLimit = i === 0 ? limit * 2 : levels[i - 1]; // bir √ºst rank limiti
            if(bestScore >= prevLimit) {
                // Bu rankƒ±n √ºst√ºndeki rankƒ± da ge√ßmi≈üiz ‚Üí bar %100 dolu
                bar.style.width = '100%';
            } else if(bestScore >= limit) {
                // Bu rankƒ±n i√ßindeyiz ‚Üí limitten prevLimit'e ne kadar ilerlediƒüimiz
                const pct = ((bestScore - limit) / (prevLimit - limit)) * 100;
                bar.style.width = Math.min(pct, 100) + '%';
            } else {
                // Bu ranka hen√ºz ula≈ümadƒ±k ‚Üí bo≈ü
                bar.style.width = '0%';
            }
        });
        document.getElementById('rank-panel').classList.remove('hidden');
    }
    function hideRankPanel() { document.getElementById('rank-panel').classList.add('hidden'); }
    function showSettings() {
        document.getElementById('vib-toggle-btn').checked = isVibrationEnabled;
        document.getElementById('haptic-toggle-btn').checked = isHapticEnabled;
        document.getElementById('music-toggle-btn').checked = isMusicEnabled;
        document.getElementById('settings-menu').classList.remove('hidden');
    }
    function hideSettings() { document.getElementById('settings-menu').classList.add('hidden'); }

    function playSfx(audio) {
        if (!audio || !isVibrationEnabled) return;
        // iOS'ta currentTime sƒ±fƒ±rlamak bazen hata fƒ±rlatƒ±r, try/catch ile sarƒ±yoruz
        try { audio.currentTime = 0; } catch(e) {}
        audio.play().catch(() => {});
    }

    function startGame() {
        document.getElementById('main-menu').classList.add('hidden');
        resetGame();
        if(isMusicEnabled) {
            bgMusic.currentTime = 0;
            bgMusic.play().catch(() => {
                // iOS'ta autoplay engellendi ‚Äî kullanƒ±cƒ± bir sonraki dokunu≈üta ba≈ülatƒ±lacak
                document.addEventListener('touchstart', () => {
                    if(isMusicEnabled) bgMusic.play().catch(() => {});
                }, { once: true, passive: true });
            });
        }
    }

    function backToMenu() {
        if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        reviveLives = 3;
        gameOverEl.classList.add('hidden');
        document.getElementById('settings-menu').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        isGameActive = false;
    }

    function toggleMusic() {
        isMusicEnabled = document.getElementById('music-toggle-btn').checked;
        localStorage.setItem('musicEnabled', isMusicEnabled);
        if(isMusicEnabled) bgMusic.play(); else bgMusic.pause();
    }

    function toggleVibration() {
        isVibrationEnabled = document.getElementById('vib-toggle-btn').checked;
        localStorage.setItem('vibrationEnabled', isVibrationEnabled);
        if(isVibrationEnabled && navigator.vibrate) navigator.vibrate(50);
    }

    function toggleHaptic() {
        isHapticEnabled = document.getElementById('haptic-toggle-btn').checked;
        localStorage.setItem('hapticEnabled', isHapticEnabled);
        if(isHapticEnabled && navigator.vibrate) navigator.vibrate(50);
    }

    // Her ranka √∂zel kutlama temasƒ±
    const RANK_THEMES = {
        'rank-0':      { bg:'rgba(0,0,0,0.6)',    card:'#1a1a2e',        border:'#555',    color:'#aaa',    msg:'Yolculuk ba≈ülƒ±yor...', emoji:'üå±', confettiColors:['#555','#888','#aaa'] },
        'rank-500':    { bg:'rgba(0,40,0,0.7)',   card:'#1a3a1a',        border:'#a3e635', color:'#a3e635', msg:'ƒ∞lk adƒ±m atƒ±ldƒ±!', emoji:'üåø', confettiColors:['#a3e635','#84cc16','#fff'] },
        'rank-1500':   { bg:'rgba(60,0,40,0.7)',  card:'#2a0a20',        border:'#f472b6', color:'#f472b6', msg:'Motorun ƒ±sƒ±ndƒ±!', emoji:'üõµ', confettiColors:['#f472b6','#ec4899','#fff'] },
        'rank-3000':   { bg:'rgba(40,20,0,0.7)',  card:'#2a1800',        border:'#fbbf24', color:'#fbbf24', msg:'Feribot kalktƒ±!', emoji:'‚õ¥Ô∏è', confettiColors:['#fbbf24','#f59e0b','#fff'] },
        'rank-5000':   { bg:'rgba(0,30,20,0.7)',  card:'#001a10',        border:'#34d399', color:'#34d399', msg:'Motoru tam gaz!', emoji:'üèçÔ∏è', confettiColors:['#34d399','#10b981','#fff'] },
        'rank-8000':   { bg:'rgba(0,20,50,0.7)',  card:'#000d2e',        border:'#60a5fa', color:'#60a5fa', msg:'Elektrik var!', emoji:'‚ö°', confettiColors:['#60a5fa','#3b82f6','#fff'] },
        'rank-12000':  { bg:'rgba(60,0,0,0.75)',  card:'#2a0000',        border:'#ff4d4d', color:'#ff4d4d', msg:'YANIYORSUN!', emoji:'üî•', confettiColors:['#ff4d4d','#ff0000','#ff944d'] },
        'rank-20000':  { bg:'rgba(10,0,30,0.8)',  card:'#0a0018',        border:'#A855F7', color:'#A855F7', msg:'KARANLIKA HO≈ûGELDƒ∞N!', emoji:'üëë', confettiColors:['#A855F7','#7C3AED','#fff'] },
        'rank-25000':  { bg:'rgba(40,30,0,0.8)',  card:'#1f1500',        border:'#FFD700', color:'#FFD700', msg:'CHAD OLUNDU!', emoji:'üí™', confettiColors:['#FFD700','#fff176','#fff','#FFD700'] },
        'rank-35000':  { bg:'rgba(0,30,40,0.8)',  card:'#001820',        border:'#00E5FF', color:'#80DEEA', msg:'DEVASA G√ú√á!', emoji:'üêò', confettiColors:['#00BCD4','#80DEEA','#fff','#00E5FF'] },
        'rank-50000':  { bg:'rgba(40,15,0,0.8)',  card:'#200a00',        border:'#FFAB40', color:'#FFAB40', msg:'MEMO KAYBOLDU AMA SEN BULDUN!', emoji:'üêü', confettiColors:['#FF6F00','#FFAB40','#fff'] },
        'rank-70000':  { bg:'rgba(30,0,0,0.85)',  card:'#150000',        border:'#FF5252', color:'#fff',    msg:'AVLANDIK!', emoji:'üéØ', confettiColors:['#F44336','#FF9800','#4CAF50','#fff'] },
        'rank-100000': { bg:'rgba(10,0,20,0.85)', card:'#050010',        border:'#E040FB', color:'#fff',    msg:'KOZMƒ∞K G√úCE ULA≈ûILDI!', emoji:'üêû', confettiColors:['#E040FB','#40C4FF','#69F0AE','#FF6E40','#fff'] },
    };

    function triggerRankCelebration(rankData) {
        const pop    = document.getElementById('rank-up-popup');
        const bg     = document.getElementById('pop-bg');
        const card   = document.getElementById('pop-card');
        const label  = document.getElementById('pop-label');
        const name   = document.getElementById('pop-rank-name');
        const img    = document.getElementById('pop-rank-img');
        const msg    = document.getElementById('pop-msg');

        const theme = RANK_THEMES[rankData.id] || RANK_THEMES['rank-0'];

        // Tema uygula
        bg.style.background = theme.bg;
        card.style.background = theme.card;
        card.style.border = `4px solid ${theme.border}`;
        card.style.boxShadow = `0 0 40px ${theme.border}88, 0 0 80px ${theme.border}33`;
        card.style.color = theme.color;
        label.style.color = theme.color;
        name.style.color = theme.color;
        name.style.textShadow = `0 0 20px ${theme.border}`;
        name.innerText = theme.emoji + ' ' + rankData.name + ' ' + theme.emoji;
        img.src = rankData.img;
        msg.style.color = theme.color;
        msg.innerText = theme.msg;

        // G√∂ster
        pop.classList.add('show');
        createConfetti(theme.confettiColors);
        if (isHapticEnabled && navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 500]);
        setTimeout(() => {
            pop.classList.remove('show');
        }, 3500);
    }

    function createConfetti(colors) {
        const palette = colors || ['#FFD700', '#FFFFFF', '#FF6B00', '#4A76FD', '#A855F7'];
        for(let i=0; i<60; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            const size = 6 + Math.random() * 10;
            c.style.cssText = `width:${size}px;height:${size}px;border-radius:${Math.random()>0.5?'50%':'2px'};`;
            c.style.backgroundColor = palette[Math.floor(Math.random() * palette.length)];
            c.style.left = Math.random() * 100 + 'vw';
            c.style.top = '-10px';
            document.body.appendChild(c);
            c.animate([
                { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                { transform: `translate(${(Math.random()-0.5)*200}px, 100vh) rotate(${Math.random()*720}deg)`, opacity: 0 }
            ], { duration: 2000 + Math.random()*2000 }).onfinish = () => c.remove();
        }
    }

    function updateRankSystem(isNewGameStart = false) {
        let bestScore = Math.max(score, best);
        let currentRank = RANK_LEVELS.find(r => bestScore >= r.limit) || RANK_LEVELS[RANK_LEVELS.length - 1];

        headerRankBtn.classList.remove('rank-eqo-fx', 'rank-sengolo-fx', 'rank-megachad-fx', 'rank-fil-fx', 'rank-polo-fx', 'rank-engell-fx', 'rank-kozmik-fx');
        if (currentRank.fx) headerRankBtn.classList.add(currentRank.fx);

        currentRankName.innerText = currentRank.name;
        currentRankImg.src = currentRank.img;

        document.querySelectorAll('.rank-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(currentRank.id);
        if(activeItem) activeItem.classList.add('active');

        if (!isNewGameStart && isGameActive && currentRank.limit > currentRankThreshold) {
            currentRankThreshold = currentRank.limit;
            triggerRankCelebration(currentRank);
        }
        if (isNewGameStart) { currentRankThreshold = currentRank.limit; }
    }

    function spawn() {
        if(!isGameActive) return;
        dockEl.innerHTML = '';
        let fillRatio = board.flat().filter(c => c !== null).length / 64;
        let canFitLarge = false;
        for(let r=0; r <= 5; r++) {
            for(let c=0; c <= 5; c++) {
                let clear = true;
                for(let i=0; i<3; i++) for(let j=0; j<3; j++) if(board[r+i][c+j]) clear = false;
                if(clear) { canFitLarge = true; break; }
            }
            if(canFitLarge) break;
        }

        // Mevcut r√ºtbeye g√∂re zorluk seviyesi (0-12)
        const bestScore = Math.max(score, best);
        const rankIndex = RANK_LEVELS.findIndex(r => bestScore >= r.limit);
        const difficulty = rankIndex; // 0=Memo(kolay) ‚Üí 12=Kozmik(zor)

        // Rank'a g√∂re doluluk e≈üiƒüi: y√ºksek rank = daha erken k√º√ß√ºk blok
        // Memo:%75, Vakko:%70, ..., Kozmik:%40
        const fillThreshold = Math.max(0.40, 0.75 - difficulty * 0.03);

        // Rank'a g√∂re b√ºy√ºk blok havuzunu aƒüƒ±rlƒ±klandƒ±r
        // D√º≈ü√ºk rank: k√º√ß√ºk bloklar aƒüƒ±rlƒ±klƒ±, y√ºksek rank: b√ºy√ºk bloklar aƒüƒ±rlƒ±klƒ±
        let pool;
        if(!canFitLarge || fillRatio > fillThreshold) {
            pool = SHAPES_SMALL;
        } else {
            // difficulty arttƒ±k√ßa NORMAL bloƒüun aƒüƒ±rlƒ±ƒüƒ± artar
            const normalWeight = Math.min(difficulty, 8); // 0-8 arasƒ±
            const normalRepeats = [...Array(normalWeight)].flatMap(() => SHAPES_NORMAL);
            pool = [...SHAPES_SMALL, ...SHAPES_NORMAL, ...normalRepeats];
        }

        // Bir ≈üeklin board'a sƒ±ƒüƒ±p sƒ±ƒümadƒ±ƒüƒ±nƒ± kontrol et
        function canFit(shape) {
            for(let r = 0; r <= 8 - shape.length; r++) {
                for(let c = 0; c <= 8 - shape[0].length; c++) {
                    let fit = true;
                    for(let i = 0; i < shape.length && fit; i++)
                        for(let j = 0; j < shape[0].length && fit; j++)
                            if(shape[i][j] && board[r+i][c+j]) fit = false;
                    if(fit) return true;
                }
            }
            return false;
        }

        // Sƒ±ƒüabilecek bloklarƒ± filtrele, yoksa t√ºm pool kullan
        const fittingPool = pool.filter(s => canFit(s.s));
        const activePool = fittingPool.length > 0 ? fittingPool : pool;

        let currentHandNames = [];
        for(let i=0; i<3; i++) {
            let shapeObj; let attempts = 0;
            do {
                shapeObj = activePool[Math.floor(Math.random() * activePool.length)];
                attempts++;
            } while (i > 0 && shapeObj.n === currentHandNames[i-1] && attempts < 20);

            currentHandNames.push(shapeObj.n);
            const slot = document.createElement('div'); slot.className = 'slot';
            const piece = document.createElement('div'); piece.className = 'piece';
            piece.dataset.shape = JSON.stringify(shapeObj.s);
            piece.dataset.color = shapeObj.c;
            piece.style.gridTemplateColumns = `repeat(${shapeObj.s[0].length}, 16px)`;
            shapeObj.s.forEach(row => row.forEach(v => {
                const dc = document.createElement('div');
                dc.className = v ? `p-cell filled ${shapeObj.c}` : 'p-cell';
                piece.appendChild(dc);
            }));
            piece.addEventListener('pointerdown', (e) => {
                if(!isGameActive) return;
                e.preventDefault();
                const cell0 = document.getElementById('r0c0');
                const cell1 = document.getElementById('r0c1');
                const cellRect0 = cell0.getBoundingClientRect();
                const cellRect1 = cell1.getBoundingClientRect();
                const cellSize = cellRect0.width;
                const step     = cellRect1.left - cellRect0.left;
                const gap      = step - cellSize;

                piece.querySelectorAll('.p-cell').forEach(c => {
                    c.style.width  = cellSize + 'px';
                    c.style.height = cellSize + 'px';
                    c.style.borderRadius = '6px';
                });
                piece.style.gridTemplateColumns = `repeat(${shapeObj.s[0].length}, ${cellSize}px)`;
                piece.style.gap = gap + 'px';

                const pw = shapeObj.s[0].length * step - gap;
                const ph = shapeObj.s.length    * step - gap;
                const liftOffset = ph + cellSize * 0.5;
                const ox = pw / 2;
                const oy = ph / 2 + liftOffset;

                // √ñnce style'ƒ± ata, sonra body'e ta≈üƒ± ‚Äî parent offset sorununu √∂nler
                piece.style.cssText += ';position:fixed;left:' + (e.clientX - ox) + 'px;top:' + (e.clientY - oy) + 'px;z-index:1000;pointer-events:none;transition:none;';
                document.body.appendChild(piece);

                activeDrag = { el: piece, shape: shapeObj.s, color: shapeObj.c,
                    ox, oy, step, liftOffset,
                    gridOriginX: cellRect0.left,
                    gridOriginY: cellRect0.top
                };
                try { piece.setPointerCapture(e.pointerId); } catch(err) {}
            });
            slot.appendChild(piece); dockEl.appendChild(slot);
        }
        checkLose();
    }

    window.addEventListener('pointermove', (e) => {
        if(!activeDrag || !isGameActive) return;
        activeDrag.el.style.left = (e.clientX - activeDrag.ox) + 'px';
        activeDrag.el.style.top  = (e.clientY - activeDrag.oy) + 'px';
        document.querySelectorAll('.cell').forEach(c => {
            const m = c.id.match(/^r(\d+)c(\d+)$/);
            if(m && !board[+m[1]][+m[2]]) c.className = 'cell';
        });
        const coords = getTarget(e);
        if(coords && coords.every(p => !board[p.r][p.c])) {
            coords.forEach(p => document.getElementById(`r${p.r}c${p.c}`).classList.add('preview', activeDrag.color, 'filled'));
            updateExplosionPreview(coords);
        } else updateExplosionPreview(null);
    });

    function cancelDrag() {
        if(!activeDrag) return;
        const el = activeDrag.el;
        const shape = activeDrag.shape;
        // Body'den √ßƒ±kar, slot'una geri koy
        el.style.cssText = '';
        el.style.gridTemplateColumns = `repeat(${shape[0].length}, 16px)`;
        el.style.gap = '2px';
        el.querySelectorAll('.p-cell').forEach(c => {
            c.style.width = '16px'; c.style.height = '16px'; c.style.borderRadius = '4px';
        });
        el.classList.remove('dragging');
        // Slot'una bul ve geri koy
        const slots = dockEl.querySelectorAll('.slot');
        let placed = false;
        slots.forEach(slot => { if(!slot.querySelector('.piece') && !placed) { slot.appendChild(el); placed = true; } });
        if(!placed) dockEl.appendChild(el);
        updateExplosionPreview(null);
        activeDrag = null;
        document.querySelectorAll('.cell').forEach(c => {
            const m = c.id.match(/^r(\d+)c(\d+)$/);
            if(m && !board[+m[1]][+m[2]]) c.className = 'cell';
        });
    }

    window.addEventListener('pointercancel', () => { cancelDrag(); });

    window.addEventListener('pointerup', (e) => {
        if(!activeDrag) return;
        const coords = getTarget(e);
        if(coords && coords.every(p => !board[p.r][p.c])) {
            playSfx(placeSound);
            updateScore(activeDrag.shape.flat().filter(v => v).length);
            coords.forEach(p => {
                board[p.r][p.c] = activeDrag.color;
                document.getElementById(`r${p.r}c${p.c}`).className = `cell filled ${activeDrag.color}`;
            });
            const dragEl = activeDrag.el;
            activeDrag = null;
            dragEl.remove();
            checkLines(() => {
                if(dockEl.querySelectorAll('.piece').length === 0) spawn(); else checkLose();
            });
        } else {
            cancelDrag();
        }
        updateExplosionPreview(null);
    });

    function getTarget(e) {
        if(!activeDrag) return null;
        const step        = activeDrag.step;
        const liftOffset  = activeDrag.liftOffset || 0;
        const originX     = activeDrag.gridOriginX;
        const originY     = activeDrag.gridOriginY;
        // Bloƒüun g√∂rsel sol-√ºst k√∂≈üesi:
        //   x = e.clientX - ox  ‚Üí  merkez x = e.clientX - ox + pw/2 = e.clientX
        //   y = e.clientY - oy  ‚Üí  merkez y = e.clientY - oy + ph/2 = e.clientY - liftOffset
        // Bloƒüun sol-√ºst h√ºcresinin grid koordinatƒ±:
        const col = Math.round((e.clientX - activeDrag.ox - originX) / step);
        const row = Math.round((e.clientY - activeDrag.oy - originY) / step);
        const res = [];
        for(let i = 0; i < activeDrag.shape.length; i++) {
            for(let j = 0; j < activeDrag.shape[0].length; j++) {
                if(activeDrag.shape[i][j]) {
                    let tr = row + i, tc = col + j;
                    if(tr < 0 || tr >= 8 || tc < 0 || tc >= 8) return null;
                    res.push({r: tr, c: tc});
                }
            }
        }
        return res;
    }

    function updateScore(points) {
        score += points; scoreEl.innerText = score;
        if(score > best) {
            sessionHighScoreReached = true; best = score;
            localStorage.setItem('blockPuzzleHighScore', best.toString()); bestEl.innerText = best;
        }
        updateRankSystem();
    }

    function updateExplosionPreview(coords) {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('will-explode'));
        if(!coords) return;
        let tempBoard = board.map(row => [...row]);
        coords.forEach(p => tempBoard[p.r][p.c] = 'temp');
        let rs = [], cs = [];
        for(let r=0; r<8; r++) if(tempBoard[r].every(v => v !== null)) rs.push(r);
        for(let c=0; c<8; c++) { let f = true; for(let r=0; r<8; r++) if(tempBoard[r][c] === null) f = false; if(f) cs.push(c); }
        rs.forEach(r => { for(let c=0; c<8; c++) document.getElementById(`r${r}c${c}`).classList.add('will-explode'); });
        cs.forEach(c => { for(let r=0; r<8; r++) document.getElementById(`r${r}c${c}`).classList.add('will-explode'); });
    }

    function checkLines(onDone) {
        let rs = [], cs = [];
        for(let i=0; i<8; i++) { if(board[i].every(v => v)) rs.push(i); if(board.every(row => row[i])) cs.push(i); }
        let total = rs.length + cs.length;
        if(total > 0) {
            comboStreak++;
            playSfx(blastSound);
            if(total >= 2) { triggerScreenShake(); if(isHapticEnabled && navigator.vibrate) navigator.vibrate([100, 50, 100]); }
            else if(isHapticEnabled && navigator.vibrate) navigator.vibrate(50);

            let basePoints = total * 64;
            let lineMulti = 1;
            if(total === 1) lineMulti = 2;
            if(total === 2) lineMulti = 3;
            if(total >= 3) lineMulti = 5;

            // Seri √ßarpanƒ±: 1. sƒ±ra=x1, 2.=x2, 3.=x3 ...
            let streakMulti = comboStreak;
            let finalPoints = basePoints * lineMulti * streakMulti;

            updateScore(finalPoints);
            showComboText(total, comboStreak);

            const toClear = [];
            rs.forEach(r => { for(let c=0; c<8; c++) toClear.push({r,c}); });
            cs.forEach(c => { for(let r=0; r<8; r++) if(!rs.includes(r)) toClear.push({r,c}); });
            blastClearLines(rs, cs, toClear, onDone);
        } else {
            comboStreak = 0; // Sƒ±ra kƒ±rƒ±lmadƒ±, seri sƒ±fƒ±rla
            if(onDone) onDone();
        }
    }

    function triggerScreenShake() { mainWrapper.classList.add('shake-active'); setTimeout(() => mainWrapper.classList.remove('shake-active'), 300); }

    const COLOR_MAP = {
        'c-1':'#FF6B35','c-2':'#4CAF50','c-3':'#E040FB','c-4':'#FFEB3B',
        'c-5':'#42A5F5','c-6':'#26C6DA','c-7':'#EF5350','c-8':'#EC407A',
        'c-9':'#5C6BC0','c-10':'#00E676','c-11':'#FFA726','c-12':'#7C4DFF',
        'c-13':'#FF7043','c-14':'#66BB6A','c-15':'#29B6F6','c-16':'#CE93D8',
        'c-17':'#F06292','c-18':'#FFD740'
    };

    function getBlockColor(cell) {
        const cls = [...cell.classList].find(cl => cl.startsWith('c-'));
        return COLOR_MAP[cls] || '#ffffff';
    }

    // Block Blast tarzƒ± sƒ±ra temizleme animasyonu
    function blastClearLines(rs, cs, toClear, onDone) {
        // Adƒ±m 1: T√ºm silinecek h√ºcreler beyaz flash ile parlasƒ±n
        toClear.forEach(({r, c}) => {
            const cell = document.getElementById(`r${r}c${c}`);
            cell.style.transition = 'none';
            cell.style.filter = 'brightness(2.5) saturate(0)';
        });

        // Adƒ±m 2: 60ms sonra scale+fade out ‚Äî satƒ±r veya s√ºtun y√∂n√ºnde kayarak
        setTimeout(() => {
            toClear.forEach(({r, c}) => {
                const cell = document.getElementById(`r${r}c${c}`);
                const color = getBlockColor(cell);

                // Yatay satƒ±r ‚Üí y ekseninde sƒ±kƒ±≈üƒ±p kaybolur
                // Dikey s√ºtun ‚Üí x ekseninde sƒ±kƒ±≈üƒ±p kaybolur
                let tx = 0, ty = 0;
                if(rs.includes(r)) { ty = (r < 4 ? -1 : 1) * 18; }
                if(cs.includes(c)) { tx = (c < 4 ? -1 : 1) * 18; }

                cell.style.transition = 'transform 0.18s ease-in, opacity 0.18s ease-in, filter 0.18s';
                cell.style.transform = `translate(${tx}px, ${ty}px) scale(0.6)`;
                cell.style.opacity = '0';
                cell.style.filter = `brightness(1.8) drop-shadow(0 0 6px ${color})`;

                // Par√ßacƒ±klarƒ± bu h√ºcre i√ßin fƒ±rlat
                spawnBurstParticles(cell, color);
            });

            // Adƒ±m 3: 200ms sonra h√ºcreleri ger√ßekten temizle
            setTimeout(() => {
                toClear.forEach(({r, c}) => {
                    board[r][c] = null;
                    const cell = document.getElementById(`r${r}c${c}`);
                    cell.style.cssText = '';
                    cell.className = 'cell';
                });
                if(onDone) onDone();
            }, 200);
        }, 60);
    }

    function spawnBurstParticles(cell, color) {
        const rect = cell.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const sz = rect.width;

        // K√º√ß√ºk kare par√ßalar ‚Äî bloktan kopuyor gibi
        const count = 5 + Math.floor(Math.random() * 3);
        for(let i = 0; i < count; i++) {
            const p = document.createElement('div');
            const size = sz * (0.18 + Math.random() * 0.22);
            const angle = (i / count) * Math.PI * 2 + Math.random() * 0.8;
            const dist = sz * (0.8 + Math.random() * 1.4);
            const duration = 280 + Math.random() * 180;
            p.style.cssText = `
                position:fixed;
                left:${cx}px; top:${cy}px;
                width:${size}px; height:${size}px;
                background:${color};
                border-radius:3px;
                pointer-events:none;
                z-index:3000;
                box-shadow: inset 0 ${size*0.15}px 0 rgba(255,255,255,0.5);
            `;
            document.body.appendChild(p);
            p.animate([
                { transform: `translate(-50%,-50%) scale(1) rotate(0deg)`, opacity: 1 },
                { transform: `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px)) scale(0) rotate(${(Math.random()-0.5)*200}deg)`, opacity: 0 }
            ], { duration, easing: 'cubic-bezier(0.22,1,0.36,1)' }).onfinish = () => p.remove();
        }

        // Parlak beyaz nokta kƒ±vƒ±lcƒ±mlar
        for(let i = 0; i < 6; i++) {
            const p = document.createElement('div');
            const angle = Math.random() * Math.PI * 2;
            const dist = sz * (0.5 + Math.random() * 1.2);
            p.style.cssText = `
                position:fixed;
                left:${cx}px; top:${cy}px;
                width:3px; height:3px;
                background:white;
                border-radius:50%;
                pointer-events:none;
                z-index:3001;
                box-shadow: 0 0 4px 2px ${color};
            `;
            document.body.appendChild(p);
            p.animate([
                { transform: `translate(-50%,-50%)`, opacity: 1 },
                { transform: `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`, opacity: 0 }
            ], { duration: 200 + Math.random() * 150, easing: 'ease-out' }).onfinish = () => p.remove();
        }
    }

    function showComboText(lines, streak) {
        // Seri yazƒ±sƒ± (ard arda kƒ±rma)
        if(streak >= 2) {
            const streakEl = document.createElement('div');
            streakEl.className = 'dombik-text ' + (streak >= 5 ? 'ultra' : streak >= 3 ? 'super' : '');
            streakEl.style.cssText = `color:${streak >= 5 ? '#ff4dff' : streak >= 3 ? '#FFD700' : '#00E676'}; font-size:${28 + streak * 3}px; top:38%;`;
            streakEl.innerText = `üî• DOMBƒ∞K ${streak}x!`;
            document.getElementById('game-container').appendChild(streakEl);
            setTimeout(() => streakEl.remove(), 1100);
        }
        // √áoklu sƒ±ra yazƒ±sƒ±
        if(lines >= 2) {
            const lineEl = document.createElement('div');
            lineEl.className = 'dombik-text ' + (lines >= 3 ? 'ultra' : 'super');
            lineEl.style.top = '52%';
            lineEl.innerText = lines >= 3 ? 'ULTRA DOMBƒ∞K x5!' : 'S√úPER DOMBƒ∞K x3!';
            document.getElementById('game-container').appendChild(lineEl);
            setTimeout(() => lineEl.remove(), 1000);
        }
    }

    function checkLose() {
        const pieces = dockEl.querySelectorAll('.piece'); if (pieces.length === 0) return;
        let canMove = false;
        pieces.forEach(p => {
            const shape = JSON.parse(p.dataset.shape);
            for(let r=0; r <= 8 - shape.length; r++) {
                for(let c=0; c <= 8 - shape[0].length; c++) {
                    let fit = true;
                    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) if(shape[i][j] && board[r+i][c+j]) fit = false;
                    if(fit) canMove = true;
                }
            }
        });
        if(!canMove) {
            isGameActive = false; document.querySelectorAll('.cell.filled').forEach(cell => cell.classList.add('game-over-gray'));
            setTimeout(() => { if(sessionHighScoreReached) newRecordAlert.classList.remove('hidden'); gameOverEl.classList.remove('hidden'); animateNumber(0, score, finalScoreEl, 1500); startReviveCountdown(); }, 2000);
        }
    }

    function animateNumber(s, e, el, d) {
        let start = null;
        function step(ts) {
            if (!start) start = ts; const p = Math.min((ts - start) / d, 1);
            el.innerText = Math.floor(p * (e - s) + s); if (p < 1) window.requestAnimationFrame(step); else el.innerText = e;
        }
        window.requestAnimationFrame(step);
    }

    let countdownInterval = null;

    function startReviveCountdown() {
        const circle = document.getElementById('countdown-circle');
        const numEl  = document.getElementById('countdown-num');
        const reviveSection = document.getElementById('revive-section');
        const livesEl = document.getElementById('revive-lives');
        const btnRevive = document.getElementById('btn-revive');
        const totalDash = 220;
        let remaining = 10;

        // Hak durumunu g√∂ster
        if(reviveLives > 0) {
            const hearts = '‚ù§Ô∏è'.repeat(reviveLives) + 'üñ§'.repeat(3 - reviveLives);
            livesEl.innerText = hearts + ' ' + reviveLives + ' canlanma hakkƒ±n var';
            btnRevive.style.display = 'block';
        } else {
            livesEl.innerText = 'üíÄ Canlanma hakkƒ±n kalmadƒ±';
            btnRevive.style.display = 'none';
        }

        circle.style.strokeDashoffset = '0';
        circle.style.stroke = '#FFD700';
        numEl.innerText = remaining;
        reviveSection.style.display = 'block';
        if(countdownInterval) clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
            remaining--;
            numEl.innerText = remaining;
            circle.style.strokeDashoffset = ((10 - remaining) / 10 * totalDash) + '';
            if(remaining <= 2) circle.style.stroke = '#ff4d4d';
            if(remaining <= 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                reviveSection.style.display = 'none';
            }
        }, 1000);
    }

    // ‚îÄ‚îÄ √úcretsiz Stok Videolar (Mixkit CDN ‚Äî CORS yok, GitHub'da √ßalƒ±≈üƒ±r) ‚îÄ‚îÄ
    const AD_VIDEOS = [
        'https://mixkit.co/free-stock-video/download/urban-fashion-model-walking-down-the-street-28455',
        'https://mixkit.co/free-stock-video/download/young-woman-talking-on-a-video-call-on-laptop-5187',
        'https://mixkit.co/free-stock-video/download/man-hands-with-a-drone-remote-control-5162',
        'https://mixkit.co/free-stock-video/download/couple-running-in-the-rain-with-umbrella-6247',
        'https://mixkit.co/free-stock-video/download/woman-drinking-morning-coffee-looking-at-the-city-5159',
        'https://mixkit.co/free-stock-video/download/aerial-view-of-the-sea-and-sandy-beach-1090',
        'https://mixkit.co/free-stock-video/download/young-woman-smiling-while-looking-at-phone-5190',
        'https://mixkit.co/free-stock-video/download/surfer-taking-on-an-ocean-wave-1104',
    ];

    let videoReviveDone = false;
    let videoIndex = Math.floor(Math.random() * AD_VIDEOS.length); // rastgele ba≈üla
    let reviveLives = 3;
    let adTimerInterval = null;
    let adFinished = false;

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    function reviveGame() {
        if(reviveLives <= 0) return;
        // ƒ∞nternet kontrol√º
        fetch('https://www.google.com/favicon.ico', { method: 'HEAD', mode: 'no-cors', cache: 'no-store' })
            .then(() => {
                if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
                reviveLives--;
                startVideoPlayback();
            })
            .catch(() => {
                showToast('üì∂ ƒ∞nternet baƒülantƒ±sƒ± yok! Reklam izlenemiyor.');
            });
    }

    function startVideoPlayback() {
        const overlay = document.getElementById('video-overlay');
        const skipBtn = document.getElementById('ad-skip-btn');
        const skipInfo = document.getElementById('ad-skip-info');
        const secondsEl = document.getElementById('ad-seconds');

        // Video se√ß (d√∂ng√ºsel, rastgele)
        const src = AD_VIDEOS[videoIndex % AD_VIDEOS.length];
        videoIndex++;

        // Video elementini sƒ±fƒ±rdan olu≈ütur
        const oldVideo = document.getElementById('ad-video');
        const newVideo = document.createElement('video');
        newVideo.id = 'ad-video';
        newVideo.style.cssText = 'width:100%; height:100%; object-fit:cover; display:block;';
        newVideo.setAttribute('playsinline', '');
        newVideo.setAttribute('webkit-playsinline', '');
        newVideo.setAttribute('muted', '');
        newVideo.setAttribute('preload', 'auto');
        newVideo.muted = true;
        newVideo.playsInline = true;
        oldVideo.replaceWith(newVideo);

        videoReviveDone = false;
        adFinished = false;
        skipBtn.style.display = 'none';
        skipInfo.style.display = 'block';
        overlay.style.display = 'flex';

        // Geri sayƒ±m ‚Äî 15 saniye izle, sonra canlan butonu √ßƒ±ksƒ±n
        let remaining = 15;
        secondsEl.innerText = remaining;
        if(adTimerInterval) clearInterval(adTimerInterval);
        adTimerInterval = setInterval(() => {
            remaining--;
            secondsEl.innerText = remaining;
            if(remaining <= 0) {
                clearInterval(adTimerInterval);
                adTimerInterval = null;
                adFinished = true;
                skipBtn.style.display = 'block';
                skipInfo.style.display = 'none';
            }
        }, 1000);

        // Video y√ºkle ve oynat
        newVideo.onended = () => {
            adFinished = true;
            skipBtn.style.display = 'block';
            skipInfo.style.display = 'none';
        };
        newVideo.onerror = () => {
            // Video y√ºklenemedi ‚Äî ba≈üka videoyu dene
            clearInterval(adTimerInterval);
            const nextSrc = AD_VIDEOS[videoIndex % AD_VIDEOS.length];
            videoIndex++;
            newVideo.src = nextSrc;
            newVideo.load();
            newVideo.play().catch(() => {
                // Hi√ßbiri √ßalƒ±≈ümadƒ±, direkt canlandƒ±r
                overlay.style.display = 'none';
                clearInterval(adTimerInterval);
                doRevive();
            });
        };

        newVideo.src = src;
        newVideo.load();
        newVideo.play().catch(() => {
            // iOS autoplay engeli ‚Äî dokunmayƒ± bekle
            newVideo.addEventListener('touchstart', () => newVideo.play().catch(() => {}), { once: true, passive: true });
        });
    }

    function skipVideoNow() {
        if(!adFinished) return; // 15 saniye dolmadan √ßalƒ±≈ümaz
        clearInterval(adTimerInterval);
        adTimerInterval = null;
        closeVideoAndRevive();
    }

    // Eski skipVideo fonksiyonu (bo≈ü bƒ±rak ‚Äî artƒ±k skipVideoNow kullanƒ±lƒ±yor)
    function skipVideo() {}

    function closeVideoAndRevive() {
        if(videoReviveDone) return;
        videoReviveDone = true;
        clearInterval(adTimerInterval);
        adTimerInterval = null;
        const overlay = document.getElementById('video-overlay');
        const videoEl = document.getElementById('ad-video');
        if(videoEl) { videoEl.onended = null; videoEl.onerror = null; videoEl.pause(); }
        overlay.style.display = 'none';
        doRevive();
    }

    function doRevive() {
        newRecordAlert.classList.add('hidden');
        gameOverEl.classList.add('hidden');
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('game-over-gray'));
        isGameActive = true;
        sessionHighScoreReached = false;
        spawn();
    }

    function resetGame() {
        if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        reviveLives = 3;
        comboStreak = 0;
        hideSettings(); score = 0; sessionHighScoreReached = false; scoreEl.innerText = "0";
        isGameActive = true; board = Array(8).fill().map(() => Array(8).fill(null));
        gridEl.innerHTML = '';
        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                const cell = document.createElement('div'); cell.className = 'cell'; cell.id = `r${r}c${c}`; gridEl.appendChild(cell);
            }
        }
        gameOverEl.classList.add('hidden'); spawn(); updateRankSystem(true);
    }
    updateRankSystem(true);
</script>
</body>
</html>

